name: Desplegar en VPS

on:
  push:
    branches: [ main ]

  workflow_dispatch:

jobs:
  desplegarEnVPS:
    runs-on: ubuntu-latest
    name: Desplegar en VPS
    steps:
    - uses: actions/checkout@v2.3.4
      env:
        VPN_EMAIL: ${{ secrets.VPN_EMAIL }}
        VPN_PASSWORD: ${{ secrets.VPN_PASSWORD }}
        HOP_SERVER: ${{ secrets.HOP_SERVER }}
        HOP_PASSWORD: ${{ secrets.HOP_PASSWORD }}
        SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
    - name: Instalar VPNC
      run: |
          sudo apt-get update
          sudo apt-get install vpnc
          echo -en "IPSEC gateway galeria.ucm.es\n IPSEC ID ucm\n IPSEC secret ucm\n XAuth username $VPN_EMAIL\n XAuth obfuscated password $VPN_PASSWORD" > vpn.conf
          sudo vpnc /home/runner/work/hypefit/hypefit/vpn
          rm vpn.conf
    - name: Crear túnel SSH
      run: | 
          sudo apt-get update
          sudo apt-get install expect
          /usr/bin/expect .github/scripts/crearTunel.exp
    - name: Enviar archivos por SCP y configurar permisos en el VPS
      run: |
        zip -x ".*" -r proyecto.zip .
        /usr/bin/expect .github/scripts/mandarArchivo.exp
        /usr/bin/expect .github/scripts/configurarVPS.exp
    - name: Cerrar túnel SSH y desconectar VPN
      run: |
        pkill ssh
        sudo vpnc-disconnect
